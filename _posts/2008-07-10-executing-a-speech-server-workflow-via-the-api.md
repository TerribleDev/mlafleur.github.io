---
Title: >
  Executing a Speech Server Workflow via
  the API
Published: 2008-07-10 22:23:50
Excerpt: ""
Tags: Skype
views:
  - 'a:1:{i:0;s:3:"338";}'
dsq_thread_id:
  - 'a:1:{i:0;s:10:"3538634953";}'
author:
  - Marc LaFleur
post_date:
  - 2008-07-10 22:23:50
post_excerpt:
  - ""
permalink:
  - >
    /executing-a-speech-server-workflow-via-the-api/
---
<p>In my <a href="http://weblogs.asp.net/mlafleur/archive/2008/07/09/getting-started-with-the-speech-server-2007-api.aspx" target="_blank">previous post</a> I outlined a basic framework for using the Core API for Speech Server 2007. Today I'll outline how to mix both the API and Workflow models by calling out to a workflow using the API and returning control back when it is complete. </p>  <p>If you are interested in the complete project code you may <a href="http://www.massivescale.com/sample_code/VoiceResponseWorkflowApplication2.zip" target="_blank">download it here</a>. </p>  <p>I'm starting with the same basic framework from my last post. To this I'm adding a simple Voice Response Workflow with a single Statement activity. Rather than calling the synthesizer from the API, I'm going to use the Statement activity inside the workflow.&#160; We're going to pass in the text we want it to play at runtime. </p>  <p>1) The first thing we need to do is add a new Voice Response Workflow to the project. Too this we'll add a single Statement activity. Because we've established the call using the API there is no AnswerCall, MakeCall, or DisconnectCall activities in this workflow.</p>  <p><a href="http://weblogs.asp.net/blogs/mlafleur/WindowsLiveWriter/ExecutingaSpeechServerWorkflowviatheAPI_102B2/image_2.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="196" alt="image" src="http://weblogs.asp.net/blogs/mlafleur/WindowsLiveWriter/ExecutingaSpeechServerWorkflowviatheAPI_102B2/image_thumb.png" width="244" border="0" /></a> </p>  <p>&#160;</p>  <p>2) Now that we have our really-big-and-complex workflow ready, we can start adding some code to set the prompt. The first thing we need to do is add a handler for the TurnStarting event. This is where we will assign the Main Prompt property for the activity.</p>  <p>3) Next we need to add a property to pass in our input parameters too. We'll call this MyPrompt. The resulting code behind should look like the following:</p>  <p><font face="Courier New">using System;      <br />using System.ComponentModel;       <br />using System.ComponentModel.Design;       <br />using System.Collections;       <br />using System.Diagnostics;       <br />using System.Drawing;       <br />using System.Workflow.ComponentModel.Compiler;       <br />using System.Workflow.ComponentModel.Serialization;       <br />using System.Workflow.ComponentModel;       <br />using System.Workflow.ComponentModel.Design;       <br />using System.Workflow.Runtime;       <br />using System.Workflow.Activities;       <br />using System.Workflow.Activities.Rules;       <br />using Microsoft.SpeechServer.Dialog; </font></p>  <p><font face="Courier New">namespace VoiceResponseWorkflowApplication2      <br />{       <br />&#160;&#160;&#160; public sealed partial class Workflow1: SpeechSequentialWorkflowActivity       <br />&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; public Workflow1()       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; InitializeComponent();&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; private string _myPrompt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; public string MyPrompt       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; get { return _myPrompt; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; set { _myPrompt = value; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; private void statementActivity1_TurnStarting(object sender, TurnStartingEventArgs e)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; statementActivity1.MainPrompt.SetText(MyPrompt);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160; }       <br />}</font></p>  <p>4) Now we need to add some code to kick off the workflow. We'll do this from within the OpenCompleted event handler in Class1.cs. This code establishes an input parameter Dictionary&lt;&gt;, instantiates the workflow object, and starts the workflow. We'll add a handler for the WorkflowCompleted event so that we can cleanup the call once the workflow is done.&#160; </p>  <p><font face="Courier New">Dictionary&lt;string, object&gt; inputParam = new Dictionary&lt;string, object&gt;();      <br />inputParam.Add(&quot;MyPrompt&quot;, &quot;HelloWorld&quot;);       <br />myWorkflow = SpeechSequentialWorkflowActivity.CreateWorkflow(_host, typeof(Workflow1), inputParam);       <br />myWorkflow.WorkflowRuntime.WorkflowCompleted += new EventHandler&lt;WorkflowCompletedEventArgs&gt;(WorkflowRuntime_WorkflowCompleted);       <br />SpeechSequentialWorkflowActivity.Start(myWorkflow);</font></p>  <p>One interesting item here is the inputParam object. The way this works is that you pass in parameters to the workflow and it assigns the values to the corresponding public properties of the workflow. If you pass an input parameter for which there is no property you will get an exception. </p>  <p>The complete Class1.cs: </p>  <p><font face="Courier New">using System;      <br />using System.Collections.Generic;       <br />using System.Text;       <br />using Microsoft.SpeechServer ;       <br />using Microsoft.SpeechServer.Dialog;       <br />using System.Workflow.Runtime; </font></p>  <p><font face="Courier New">namespace VoiceResponseWorkflowApplication2      <br />{       <br />&#160;&#160;&#160; public class Class1 : IHostedSpeechApplication       <br />&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; private IApplicationHost _host;       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; private WorkflowInstance myWorkflow; </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; public void Start(IApplicationHost host)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (host != null)       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host = host;       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host.TelephonySession.CurrentUICulture = System.Globalization.CultureInfo.GetCultureInfo(&quot;en-US&quot;); </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Dial and outbound call (make sure you change these numbers :-)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host.TelephonySession.OpenCompleted += new EventHandler&lt;AsyncCompletedEventArgs&gt;(TelephonySession_OpenCompleted);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host.TelephonySession.OpenAsync(&quot;7813062200&quot;, &quot;8887006263&quot;);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; else       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; throw new ArgumentNullException(&quot;host&quot;);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; void TelephonySession_OpenCompleted(object sender, AsyncCompletedEventArgs e)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (e.Error != null)       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host.TelephonySession.Close();       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; else       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Dictionary&lt;string, object&gt; inputParam = new Dictionary&lt;string, object&gt;();       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; inputParam.Add(&quot;MyPrompt&quot;, &quot;HelloWorld&quot;);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; myWorkflow = SpeechSequentialWorkflowActivity.CreateWorkflow(_host, typeof(Workflow1), inputParam);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; myWorkflow.WorkflowRuntime.WorkflowCompleted += new EventHandler&lt;WorkflowCompletedEventArgs&gt;(WorkflowRuntime_WorkflowCompleted);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SpeechSequentialWorkflowActivity.Start(myWorkflow);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; void WorkflowRuntime_WorkflowCompleted(object sender, WorkflowCompletedEventArgs e)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host.TelephonySession.Close();       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; public void Stop(bool immediate)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; public void OnUnhandledException(Exception exception)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (exception != null)       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host.TelephonySession.LoggingManager.LogApplicationError(100, &quot;An unexpected exception occurred: {0}&quot;, exception.Message);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; else       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host.TelephonySession.LoggingManager.LogApplicationError(100, &quot;An unknown exception occurred: {0}&quot;, System.Environment.StackTrace);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </font></p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _host.OnCompleted();      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160; }       <br />}</font></p>  <p><font face="Courier New">(<a href="http://www.massivescale.com/sample_code/VoiceResponseWorkflowApplication2.zip" target="_blank">download the zipped project here</a>)</font></p>